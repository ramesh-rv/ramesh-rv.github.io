<!doctype html><html lang=en-us><title>Kerberos 101 | Ramesh > Blog</title><meta charset=utf-8><meta name=generator content="Hugo 0.118.2"><meta name=description content="Ramesh > Blog"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://rvramesh.me/css/minimal.css><link rel=canonical href=https://rvramesh.me/posts/kerberos-101/><link rel=alternate type=application/rss+xml href title="Ramesh > Blog"><header><a href=https://rvramesh.me/ class=title>Ramesh > Blog</a><nav><a href=../../about/>About</a>
<a href=../../>Home</a>
<a href=../../tags/>Tags</a>
<a href=https://github.com/ramesh-rv>GitHub</a>
<a href=https://www.linkedin.com/in/ramesh-rv-b2b57a8/>LinkedIn</a></nav></header><article><header><h1>Kerberos 101</h1><time datetime=2022-07-05T13:33:27+05:30>July 05, 2022</time>
Tags: active-directory, kerberos</header><h1 id=kerberos-series-kerberos-101>Kerberos Series: Kerberos 101</h1><p>This post is part-3 of the Auror Project hosted by Sudarshan Pisupati.</p><hr><p><strong>Table of Contents</strong></p><ol><li><p><a href=#what-is-kerberos>What is Kerberos</a></p></li><li><p><a href=#how-does-authentication-through-kerberos-work>How does authentication through Kerberos work</a></p></li><li><p><a href=#kerberos-flows>Kerberos Flows</a></p><ol><li><a href=#logon-ticket-flow-tgt-flow>Logon Ticket Flow</a></li><li><a href=#service-ticket-flow-tgs-flow>Service Ticket Flow</a></li></ol></li><li><p><a href=#kerberos-flows-in-action>Kerberos Flows in Action</a></p><ol><li><a href=#user-login-to-machine-b>User login to Machine-B</a></li><li><a href=#user-tries-to-access-file-server>User tries to access file server</a></li></ol></li><li><p><a href=#final-thoughts>Final Thoughts</a></p></li></ol><hr><h2 id=what-is-kerberos>What is Kerberos</h2><p>Kerberos is a network authentication protocol developed by Massachusetts Institute of Technology (MIT). The protocol was named after &ldquo;<strong>Cerberus</strong>&rdquo;, the three headed dog in Greek Mythology.
Kerberos is designed for a client-server model and provide secure authentication over a network. Windows 2000 and later versions use Kerberos as the default authentication method.</p><hr><h2 id=how-does-authentication-through-kerberos-work>How does authentication through Kerberos work</h2><p>Authentication through Kerberos happens through a Key Distribution Center(KDC) which is a service running on the Active Directory(AD) Domain Controllers(DC).</p><p>The main components in the Kerberos Authentication Process are</p><ol><li><p><strong>Authentication Service(AS)</strong> - Authenticate users when they attempt to access a service (example: user trying to access file server)</p></li><li><p><strong>Ticket Granting Ticket (TGT)</strong> - is the Kerberos ticket for the Ticket Granting Service (runs on the KDC) and is encrypted using the KDC key</p></li><li><p><strong>Ticket Granting Service (TGS)</strong> - When the user&rsquo;s TGT is presented to the Domain Controller (DC) it determines if the TGT is valid and issues a resource access ticket (TGS) which can be used to access the target resource (example: File server)</p></li></ol><p>Every service in the Kerberos realm has a Service Principal Name (SPN) and every user in the AD domain will have a User Principal Name (UPN). For any service the SPN can be configured using the <code>setSPN</code> command.</p><table><thead><tr><th>Service</th><th>Domain</th><th>SPN</th></tr></thead><tbody><tr><td>File server</td><td>acme.corp</td><td>cifs/host1.acme.corp</td></tr></tbody></table><table><thead><tr><th>User</th><th>Domain</th><th>UPN</th></tr></thead><tbody><tr><td>Alice</td><td>acme.corp</td><td><a href=mailto:alice@acme.corp>alice@acme.corp</a></td></tr></tbody></table><hr><h2 id=kerberos-flows>Kerberos Flows</h2><p>There are two important flows that we discuss here</p><ol><li>Logon Ticket flow</li><li>Service Ticket flow</li></ol><p>The sequence diagram tries to provide an overview of both the flows</p><p><img src=../../images/2022/06/kerberos-sequence-diagram.png alt=kerberos-sequence-diagram></p><h3 id=logon-ticket-flow-tgt-flow>Logon Ticket flow (TGT Flow)</h3><ol><li>User logs into a computer that is joined to the domain &ldquo;acme.corp&rdquo; using the Active Directory username and password.</li><li>The computer creates a hash of the password when the user is logged in successfully.</li><li>Kerberos authentication is initiated by sending the PREAUTH ( timestamp encrypted with the hash of the password)</li><li>The user account (<a href=mailto:alice@acme.corp>alice@acme.corp</a>) requests a TGT with the PREAUTH data. This process is also known as <strong>Authentication Service Request</strong> or <strong>AS-REQ</strong></li><li>The Key Distribution Center (KDC) validates the PREAUTH data and issues a <strong>Ticket Granting Ticket (TGT)</strong>. This process is also known as <strong>Authentication Service Response</strong> or <strong>AS-REP</strong></li><li>The TGT contains Privileged Attribute Certificate (PAC) which has the list of security groups of the user.</li><li>The TGT is signed and encrypted by the kerberos service account &ldquo;krbtgt&rdquo; of the domain.</li><li>The contents of the TGT can be read only by the &ldquo;krbtgt&rdquo; service account which will be used as a reference during the kerberos attacks discussed later.</li></ol><p><img src=../../images/2022/06/contents-of-tgt.png alt=contents-of-TGT></p><h3 id=service-ticket-flow-tgs-flow>Service Ticket flow (TGS flow)</h3><p>In this flow , the TGT will be used as a proof of identity while requesting access to a resource</p><ol><li>When the user attempts to access a fileserver in the domain,the TGT is presented to the KDC requesting a resource access ticket (TGS). This process is also known as <strong>TGS-REQ</strong></li><li>The Domain Controller determines if the TGT is valid.</li><li>If the TGT is valid,it generates a service ticket (TGS). The service ticket is encrypted using secret key of the service and the session key generated by TGS. This process is also known as <strong>TGS-REP</strong></li><li>The user&rsquo;s computer sends the user&rsquo;s service ticket (TGS) to the file server (CIFS service).</li><li>The resource service(CIFS) validates the TGS by decrypting the TGS component encrypted using the service&rsquo;s session key.</li><li>The resource service may send the TGS to KDC to validate the user&rsquo;s group membership present in the PAC.</li><li>The service review&rsquo;s the user&rsquo;s group membership and determines the level of access that can be provided to the user.</li><li>It then allows the user to access the resource (file server).</li></ol><hr><h2 id=kerberos-flows-in-action>Kerberos Flows in Action</h2><p>To view these flows in action</p><ul><li><p>We will use the Active Directory lab we have configured earlier. I have also configured a File server running on the Domain Controller (Machine-A).</p></li><li><p>We will configure the Service Principal Name for the File server that we have configured.</p></li><li><p>Below given is the command to set SPN for the file server</p></li></ul><p><code>setspn -s cifs/aurordc.auror.local aurordc</code></p><ul><li>Output of the command</li></ul><pre tabindex=0><code>PS C:\Users\Administrator&gt; setspn -s cifs/aurordc.auror.local aurordc
Checking domain DC=auror,DC=local

Registering ServicePrincipalNames for CN=AURORDC,OU=Domain Controllers,DC=auror,DC=local
        cifs/aurordc.auror.local
Updated object
</code></pre><ul><li>To verify if the SPN is added successfully , we can run the <code>setSPN -L</code> command to list the SPN&rsquo;s added.</li></ul><p><strong>NOTE</strong>: The SPN list has been truncated and only the file server we added is presented in the output below.</p><pre tabindex=0><code>PS C:\Users\Administrator&gt; setspn -L aurordc
Registered ServicePrincipalNames for CN=AURORDC,OU=Domain Controllers,DC=auror,DC=local:
        cifs/aurordc.auror.local
</code></pre><ul><li><p>We will use Wireshark to examine the packets that flow during Kerberos login flows.</p></li><li><p>The sequence of activities that will be examined during this flow are :</p></li></ul><ol><li><p>User Alice (auror\alice) will login to Machine-B which is joined to Domain (auror.local)</p></li><li><p>User Alice will then map the file share to <code>S:\</code> drive.</p></li><li><p>User Alice will access <code>S:\</code> drive.</p></li></ol><h3 id=user-login-to-machine-b>User login to Machine-B</h3><ol><li>When the user login to Machine-B, the client sends an AS-REQ to the Authentication Server we can find the below packets when analyzed through Wireshark</li></ol><table><thead><tr><th>Field name</th><th>Content</th></tr></thead><tbody><tr><td>pdata</td><td>It is called &ldquo;Pre-Authentication Data&rdquo;. The client inserts a time stamp here and encrypt it with the client password to avoid replay attacks</td></tr><tr><td>cname</td><td>Client (user) name to be authenticated</td></tr><tr><td>realm</td><td>Domain Name</td></tr><tr><td>SName</td><td>Service Name being requested</td></tr><tr><td>till</td><td>expiration time of the ticket being requested</td></tr><tr><td>etype</td><td>encryption type the client supports</td></tr></tbody></table><p><img src=../../images/2022/07/as-req-process-captured-in-wireshark.png alt=as-req-process-captured-in-wireshark></p><ol start=2><li>The Authentication server responds with AS-REP packet to the client. The AS-REP packet contains a TGT (which is encrypted by krbtgt) and a session key</li></ol><p><img src=../../images/2022/07/as-rep-process-captured-in-wireshark.png alt=as-rep-process-captured-in-wireshark></p><ol start=3><li>We can view the TGT cached on Machine-B by issuing the command <code>klist tgt | more</code> in Powershell</li></ol><p><img src=../../images/2022/07/cached-tgt-on-machine-b.png alt=cached-tgt-on-machine-B></p><hr><h3 id=user-tries-to-access-file-server>User tries to access file-server</h3><ol><li>User tries to map the file server to a drive on Machine-B and access the contents of the drive.</li></ol><p><img src=../../images/2022/07/map-file-server-on-machine-b.png alt=map-file-server-on-machine-B></p><ul><li>During this process the client makes a TGS-REQ to the TGS. The request contains the encrypted TGT and an authenticator using the <strong>client&rsquo;s session key</strong>.</li></ul><p><img src=../../images/2022/07/tgs-req-process-captured-in-wireshark.png alt=tgs-req-process-captured-in-wireshark></p><ul><li><p>Through this request, the client is asking the server for a service ticket.</p></li><li><p>When the TGS receives this request it decrypts the TGT using the master key (encrypted by krbtgt)</p></li><li><p>The TGS construcs a service ticket and encrypts it with another secret key which is shared between TGS and the File Server.</p></li><li><p>The service ticket includes information such as service name, client id, expiry date, a new session key, the client’s address etc.</p></li></ul><p><img src=../../images/2022/07/tgs-rep-captured-in-wireshark.png alt=tgs-rep-captured-in-wireshark></p><hr><h2 id=final-thoughts>Final Thoughts</h2><ul><li>Kerberos has been widely used due to the ticket mechanism it offers.</li><li>It also supports different operating systems such as Microsoft Windows, Apple macOS , Linux.</li><li>Both sides (Client and Server) mutually authenticate each other through the protocol.</li></ul><hr></article></html>